{% extends "themes/NeoLearn/includes/modal_generic.html" %}

{% block formModal %}

<form id="formCreateLesson" method="POST" action="" enctype="multipart/form-data" class="modal-body">
  {% csrf_token %}
  <div class="modal-body">

    <!-- T√≠tulo -->
    <div class="form-group">
      <label class="form-label">
        T√≠tulo da Aula
        <span class="required-mark">*</span>
      </label>
      <input type="text" name="title" id="moduleTitle" class="form-input" placeholder="Ex: Introdu√ß√£o ao Django" required>
    </div>

    <!-- Tipo de Conte√∫do -->
    <div class="form-group">
      <label class="form-label">Tipo de Conte√∫do</label>
      <select name="content_type" id="moduleContentType" class="form-select" onchange="changeLessonType(this.value)">
        <option value="video">üé• V√≠deo</option>
        <option value="text">üìÑ Texto</option>
        <option value="quiz">‚ùì Quiz</option>
        <option value="file">üìÅ Arquivo</option>
      </select>
    </div>

    <!-- üîπ Campo: Texto -->
    <div class="lesson-content-fields" id="lessonTextFields" style="display:none;">
      <div class="form-group">
        <label class="form-label">Conte√∫do em Texto</label>
        <textarea name="content_text" class="form-textarea" rows="6" placeholder="Digite o conte√∫do desta mat√©ria..."></textarea>
      </div>
    </div>

    <!-- üîπ Campo: V√≠deo -->
    <div class="lesson-content-fields" id="lessonVideoFields">
      <div id="video-upload-container">
        <div class="video-upload-item">
          <label class="form-label">T√≠tulo do V√≠deo</label>
          <input type="text" name="video_titles[]" class="form-input" placeholder="Ex: Parte 1">

          <label class="form-label mt-2">Arquivo de V√≠deo</label>
          <input type="file" name="video_files[]" class="form-input video-input" accept="video/*">

          <input type="hidden" name="video_durations[]" class="video-duration-field">
          <small class="form-hint duration-display"></small>
        </div>
      </div>

      <button type="button" class="btn small secondary mt-2" onclick="addVideoField()">+ Adicionar outro v√≠deo</button>
    </div>

    <br>

    <!-- Campo de dura√ß√£o total (s√≥ para v√≠deo) -->
    <div class="form-group" id="lesssonDurationField">
      <label class="form-label">Dura√ß√£o total (minutos)</label>
      <input type="number" step="0.001" name="duration" id="lessonDuration" class="form-input" readonly>
      <span class="form-hint">Calculado automaticamente com base nos v√≠deos enviados</span>
    </div>

    <!-- üîπ Campo: Quiz -->
    <div class="lesson-content-fields" id="lessonQuizFields" style="display:none;">
      <div class="form-group">
        <label class="form-label">Pergunta do Quiz</label>
        <input type="text" name="quiz_question" class="form-input" placeholder="Ex: O que √© um template Django?">
      </div>
      <div class="form-group">
        <label class="form-label">Respostas (separe por v√≠rgulas)</label>
        <input type="text" name="quiz_answers" class="form-input" placeholder="Ex: Verdadeiro,Falso,Depende">
        <span class="form-hint">üëâ A <b>primeira</b> resposta √© considerada a correta</span>
      </div>
    </div>

    <!-- üîπ Campo: Arquivo -->
    <div class="lesson-content-fields" id="lessonFileFields" style="display:none;">
      <div class="form-group">
        <label class="form-label">Arquivo da Mat√©ria</label>
        <input type="file" name="content_file" class="form-input">
        <span class="form-hint">Envie PDFs, imagens ou documentos de apoio</span>
      </div>
    </div>

    <!-- Descri√ß√£o -->
    <div class="form-group">
      <label class="form-label">Descri√ß√£o</label>
      <textarea name="description" id="moduleDescription" class="form-textarea" rows="3" placeholder="Descreva brevemente esta mat√©ria..."></textarea>
    </div>

    <!-- Ordem e Status -->
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Ordem</label>
        <input type="number" name="order" id="moduleOrder" class="form-input" min="1" value="1">
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select name="status" id="moduleStatus" class="form-select">
          <option value="draft">Rascunho</option>
          <option value="published">Publicado</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label class="checkbox-label">
        <input type="checkbox" name="is_free">
        <span class="checkbox-custom"></span>
        Aula gratuita (pr√©via)
      </label>
    </div>

  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-outline" onclick="closeModal('{{ modal_id }}')">Cancelar</button>
    <button type="submit" class="btn btn-primary">Salvar Mat√©ria</button>
  </div>
</form>

<!-- üß† Script: captura dura√ß√£o real dos v√≠deos -->
<script>
function addVideoField() {
  const container = document.getElementById('video-upload-container');
  const newItem = document.createElement('div');
  newItem.classList.add('video-upload-item');
  newItem.innerHTML = `
    <hr>
    <label class="form-label">T√≠tulo do V√≠deo</label>
    <input type="text" name="video_titles[]" class="form-input" placeholder="Ex: Parte 2">
    <label class="form-label mt-2">Arquivo de V√≠deo</label>
    <input type="file" name="video_files[]" class="form-input video-input" accept="video/*">
    <input type="hidden" name="video_durations[]" class="video-duration-field">
    <small class="form-hint duration-display"></small>
  `;
  container.appendChild(newItem);
  attachDurationListeners();
}

function attachDurationListeners() {
  document.querySelectorAll('.video-input').forEach(input => {
    input.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const video = document.createElement('video');
      video.preload = 'metadata';
      video.onloadedmetadata = () => {
        window.URL.revokeObjectURL(video.src);
        const durationMin = (video.duration / 60).toFixed(3);
        const durationField = e.target.closest('.video-upload-item').querySelector('.video-duration-field');
        const display = e.target.closest('.video-upload-item').querySelector('.duration-display');
        durationField.value = durationMin;
        display.textContent = `‚è±Ô∏è ${Math.floor(video.duration / 60)}:${Math.round(video.duration % 60).toString().padStart(2, "0")}`;
        updateTotalDuration();
      };
      video.src = URL.createObjectURL(file);
    });
  });
}

function updateTotalDuration() {
  let total = 0;
  document.querySelectorAll('.video-duration-field').forEach(input => {
    total += parseFloat(input.value || 0);
  });
  const totalField = document.getElementById('lessonDuration');
  if (totalField) totalField.value = total.toFixed(3);
}

document.addEventListener('DOMContentLoaded', attachDurationListeners);
</script>

{% endblock %}
