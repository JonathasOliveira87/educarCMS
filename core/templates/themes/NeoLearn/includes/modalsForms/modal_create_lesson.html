{% extends "themes/NeoLearn/includes/modal_generic.html" %}

{% block formModal %}

<form id="formCreateLesson" method="POST" action="" enctype="multipart/form-data" class="modal-body">
  {% csrf_token %}
  <div class="modal-body">

    <!-- T√≠tulo -->
    <div class="form-group">
      <label class="form-label">
        T√≠tulo da Aula
        <span class="required-mark">*</span>
      </label>
      <input type="text" name="title" id="moduleTitle" class="form-input" placeholder="Ex: Introdu√ß√£o ao Django" required>
    </div>

    <!-- Tipo de Conte√∫do -->
    <div class="form-group">
      <label class="form-label">Tipo de Conte√∫do</label>
      <select name="content_type" id="moduleContentType" class="form-select" onchange="changeLessonType(this.value)">
        <option value="video">üé• V√≠deo</option>
        <option value="text">üìÑ Texto</option>
        <option value="quiz">‚ùì Quiz</option>
        <option value="file">üìÅ Arquivo</option>
      </select>
    </div>

    <!-- üîπ Campo: Texto -->
    <div class="lesson-content-fields" id="lessonTextFields" style="display:none;">
      <div class="form-group">
        <label class="form-label">Conte√∫do em Texto</label>
        <textarea name="content_text" class="form-textarea" rows="6" placeholder="Digite o conte√∫do desta mat√©ria..."></textarea>
      </div>
    </div>

    <!-- üîπ Campo: V√≠deo (Apenas 1 v√≠deo permitido) -->
    <div class="lesson-content-fields" id="lessonVideoFields">

      <div class="video-upload-item">

        <label class="form-label">T√≠tulo do V√≠deo</label>
        <input type="text" name="video_title" class="form-input" placeholder="Ex: Introdu√ß√£o">

        <label class="form-label mt-2">Arquivo de V√≠deo</label>
        <input type="file" name="video_file" class="form-input video-input" accept="video/*">

        <input type="hidden" name="video_duration" id="videoDurationField">
        <small class="form-hint" id="videoDurationDisplay"></small>

      </div>

    </div>

    <br>

    <!-- Campo de dura√ß√£o total (s√≥ para v√≠deo) -->
    <input type="hidden" name="duration" id="lessonDuration">

    <!-- üîπ Campo: Quiz -->
    <div class="lesson-content-fields" id="lessonQuizFields" style="display:none;">
      <div class="form-group">
        <label class="form-label">Pergunta do Quiz</label>
        <input type="text" name="quiz_question" class="form-input" placeholder="Ex: O que √© um template Django?">
      </div>
      <div class="form-group">
        <label class="form-label">Respostas (separe por v√≠rgulas)</label>
        <input type="text" name="quiz_answers" class="form-input" placeholder="Ex: Verdadeiro,Falso,Depende">
        <span class="form-hint">üëâ A <b>primeira</b> resposta √© considerada a correta</span>
      </div>
    </div>

    <!-- üîπ Campo: Arquivo -->
    <div class="lesson-content-fields" id="lessonFileFields" style="display:none;">
      <div class="form-group">
        <label class="form-label">Arquivo da Mat√©ria</label>
        <input type="file" name="content_file" class="form-input">
        <span class="form-hint">Envie PDFs, imagens ou documentos de apoio</span>
      </div>
    </div>

    <!-- Descri√ß√£o -->
    <div class="form-group">
      <label class="form-label">Descri√ß√£o</label>
      <textarea name="description" id="moduleDescription" class="form-textarea" rows="3" placeholder="Descreva brevemente esta mat√©ria..."></textarea>
    </div>

    <!-- Ordem e Status -->
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Ordem</label>
        <input type="number" name="order" id="moduleOrder" class="form-input" min="1" value="1">
      </div>
      <div class="form-group">
        <label class="form-label">Status</label>
        <select name="status" id="moduleStatus" class="form-select">
          <option value="draft">Rascunho</option>
          <option value="published">Publicado</option>
        </select>
      </div>
    </div>


  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-outline" onclick="closeModal('{{ modal_id }}')">Cancelar</button>
    <button type="submit" class="btn btn-primary">Salvar Mat√©ria</button>
  </div>
</form>

<!-- üß† Script: captura dura√ß√£o real do v√≠deo -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const videoInput = document.querySelector(".video-input");

  videoInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    const video = document.createElement("video");
    video.preload = "metadata";

    video.onloadedmetadata = () => {
      URL.revokeObjectURL(video.src);

      const durationMin = (video.duration / 60).toFixed(3);

      document.getElementById("videoDurationField").value = durationMin;

      const display = document.getElementById("videoDurationDisplay");
      display.textContent =
        `‚è±Ô∏è ${Math.floor(video.duration / 60)}:` +
        `${Math.round(video.duration % 60).toString().padStart(2, "0")}`;

      // Preenche campo de dura√ß√£o total
      const totalField = document.getElementById("lessonDuration");
      if (totalField) totalField.value = durationMin;
    };

    video.src = URL.createObjectURL(file);
  });
});
</script>


{% endblock %}
