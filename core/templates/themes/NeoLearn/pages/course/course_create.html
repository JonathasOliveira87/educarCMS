{% extends "themes/NeoLearn/base.html" %}
{% load static %}

{% block title %}Criar Curso - {{ school.name }}{% endblock %}
{% block body_class %}course-create-page{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <div class="breadcrumb">
            <a href="{% url 'school_dashboard' school.slug %}">Dashboard</a>
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M6 12l4-4-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <a href="{% url 'course_list' school.slug %}">Cursos</a>
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M6 12l4-4-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Criar Curso</span>
        </div>
        <h1 class="page-title">Criar Novo Curso</h1>
        <p class="page-subtitle">Preencha as informações básicas do seu curso</p>
    </div>
</div>

<form method="POST" enctype="multipart/form-data" class="course-create-form" id="courseCreateForm">
    {% csrf_token %}
    <div class="form-grid">
        
        <!-- Coluna Principal -->
        <div class="form-main">
            <!-- Informações Básicas -->
            <div class="form-section">
                <div class="section-header">
                    <h2 class="section-title">Informações Básicas</h2>
                    <span class="section-badge required">* Obrigatório</span>
                </div>

                <!-- Titulo -->
                <div class="form-group">
                    <label for="title" class="form-label">
                        Título do Curso
                        <span class="required-mark">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="title" 
                        name="title" 
                        class="form-input"
                        placeholder="Ex: Introdução ao Python para Iniciantes"
                        required
                        maxlength="500"
                    >
                    <span class="form-hint">Um título claro e descritivo ajuda os alunos a encontrar seu curso</span>
                </div>

                 <!-- Descrição curta -->
                <div class="form-group">
                    <label for="short_description" class="form-label">
                        Descrição Curta
                        <span class="required-mark">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="short_description" 
                        name="short_description" 
                        class="form-input"
                        placeholder="Resumo do curso em uma linha"
                        required
                        maxlength="100"
                    >
                    <span class="form-hint">Uma descrição curta e objetiva ajuda os alunos a entender rapidamente sobre o que é o curso</span>
                </div>

                <!-- Descrição completa -->
                <div class="form-group">
                    <label for="description" class="form-label">
                        Descrição Completa
                        <span class="required-mark">*</span>
                    </label>
                    <textarea 
                        id="description" 
                        name="description" 
                        class="form-textarea"
                        rows="8"
                        placeholder="Descreva o que os alunos aprenderão, os tópicos abordados e os benefícios do curso...">
                    </textarea>
                    <span class="form-hint">Seja detalhado sobre o conteúdo e objetivos do curso</span>
                </div>
            </div>
            
            <!-- Objetivos e Requisitos -->
            <div class="form-section">
                <div class="section-header">
                    <h2 class="section-title">Objetivos e Requisitos</h2>
                    <span class="section-badge">Opcional</span>
                </div>

                <!-- Objetivos -->
                <div class="form-group">
                    <label for="objectives" class="form-label">O que os alunos aprenderão?</label>
                    <textarea 
                        id="objectives" 
                        name="objectives" 
                        class="form-textarea"
                        rows="6"
                        placeholder="• Conceitos fundamentais de programação&#10;• Estruturas de dados básicas&#10;• Criação de projetos práticos&#10;• Boas práticas de desenvolvimento"
                    ></textarea>
                    <span class="form-hint">Liste os principais objetivos de aprendizado (um por linha)</span>
                </div>

                <!-- Requisitos -->
                <div class="form-group">
                    <label for="requirements" class="form-label">Pré-requisitos</label>
                    <textarea 
                        id="requirements" 
                        name="requirements" 
                        class="form-textarea"
                        rows="5"
                        placeholder="• Conhecimento básico de informática&#10;• Computador com acesso à internet&#10;• Vontade de aprender"
                    ></textarea>
                    <span class="form-hint">Informe o que é necessário para fazer o curso</span>
                </div>
            </div>
            
            <!-- Mídia -->
            <div class="form-section">
                <div class="section-header">
                    <h2 class="section-title">Imagem e Vídeo</h2>
                    <span class="section-badge">Opcional</span>
                </div>
                
                <div class="form-group">
                    <label for="thumbnail" class="form-label">Imagem de Capa</label>
                    <div class="file-upload-area" id="thumbnailUploadArea">
                        <input 
                            type="file" 
                            id="thumbnail" 
                            name="thumbnail" 
                            accept="image/*"
                            hidden
                        >
                        <div class="file-upload-content">
                            <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                                <rect x="6" y="10" width="36" height="28" rx="2" stroke="currentColor" stroke-width="2"/>
                                <circle cx="16" cy="20" r="3" stroke="currentColor" stroke-width="2"/>
                                <path d="M6 32l8-8 6 6 8-8 14 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <h4>Clique para fazer upload ou arraste a imagem</h4>
                            <p>PNG, JPG ou WEBP (máx. 2MB) - Recomendado: 1280x720px</p>
                        </div>
                        <div class="file-preview" id="thumbnailPreview" style="display: none;">
                            <img src="" alt="Preview">
                            <button type="button" class="remove-file" onclick="removeThumbnail()">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                    <path d="M15 5L5 15M5 5l10 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Vídeo URL -->
                <div class="form-group">
                    <label for="video_intro" class="form-label">Vídeo de Introdução (URL)</label>
                    <input 
                        type="url" 
                        id="video_intro" 
                        name="video_intro" 
                        class="form-input"
                        placeholder="https://youtube.com/watch?v=..."
                    >
                    <span class="form-hint">Link do YouTube, Vimeo ou outro serviço de vídeo</span>
                </div>
            </div>

        </div>
        
        <!-- Sidebar -->
        <div class="form-sidebar">
            <!-- Status e Publicação -->
            <div class="sidebar-card">
                <h3 class="card-title">Publicação</h3>
                
                <div class="form-group">
                    <label for="status" class="form-label">Status</label>
                    <select id="status" name="status" class="form-select">
                        <option value="draft" selected>Rascunho</option>
                        <option value="active">Ativo (Publicado)</option>
                        <option value="archived">Arquivado</option>
                    </select>
                </div>
                
                <div class="status-info">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M8 4v5M8 11h.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    <span>Cursos em rascunho não aparecem no catálogo</span>
                </div>
            </div>
            
            <!-- Categoria e Nível -->
            <div class="sidebar-card">
                <h3 class="card-title">Categoria e Nível</h3>
                
                <div class="form-group">
                    <label for="category" class="form-label">
                        Categoria
                        <span class="required-mark">*</span>
                    </label>
                    <div class="input-with-action">
                        <select id="category" name="category" class="form-select" required>
                            <option value="">Selecione uma categoria</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn-add-category" onclick="openModal('modalCreateCategory')">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Nova
                        </button>
                    </div>
                    {% if not categories %}
                    <div class="alert-inline warning">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M8 1L1 14h14L8 1z" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M8 6v3M8 11h.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span>Nenhuma categoria cadastrada. Crie uma categoria antes de continuar.</span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="level" class="form-label">
                        Nível de Dificuldade
                        <span class="required-mark">*</span>
                    </label>
                    <select id="level" name="level" class="form-select" required>
                        <option value="beginner">Iniciante</option>
                        <option value="intermediate">Intermediário</option>
                        <option value="advanced">Avançado</option>
                    </select>
                </div>
            </div>
            
            <!-- Configurações -->
            <div class="sidebar-card">
                <h3 class="card-title">Configurações</h3>
                
                <div class="form-group">
                    <label for="duration_hours" class="form-label">Duração Total (horas)</label>
                    <input 
                        type="number" 
                        id="duration_hours" 
                        name="duration_hours" 
                        class="form-input"
                        min="0"
                        placeholder="Ex: 8"
                    >
                </div>
                
                <div class="form-group">
                    <label for="price" class="form-label">Preço (R$)</label>
                    <input 
                        type="number" 
                        id="price" 
                        name="price" 
                        class="form-input"
                        min="0"
                        step="0.01"
                        placeholder="0.00"
                        value="0.00"
                    >
                    <span class="form-hint">Digite 0.00 para curso gratuito</span>
                </div>
                
                <div class="form-group">
                    <label for="max_students" class="form-label">Limite de Alunos</label>
                    <input 
                        type="number" 
                        id="max_students" 
                        name="max_students" 
                        class="form-input"
                        min="1"
                        placeholder="Ilimitado"
                    >
                    <span class="form-hint">Deixe em branco para ilimitado</span>
                </div>
            </div>
            
            <!-- Recursos -->
            <div class="sidebar-card">
                <h3 class="card-title">Recursos</h3>
                
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="certificate_available">
                        <span class="checkbox-custom"></span>
                        <div class="checkbox-text">
                            <strong>Certificado de Conclusão</strong>
                            <small>Emitir certificado ao final</small>
                        </div>
                    </label>
                    
                    <label class="checkbox-label">
                        <input type="checkbox" name="is_featured">
                        <span class="checkbox-custom"></span>
                        <div class="checkbox-text">
                            <strong>Curso em Destaque</strong>
                            <small>Aparecer na página inicial</small>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Ações -->
            <div class="sidebar-actions">
                <button type="submit" class="btn btn-primary btn-block">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Criar Curso
                </button>
                <a href="{% url 'course_list' school.slug %}" class="btn btn-outline btn-block">
                    Cancelar
                </a>
            </div>
        </div>

    </div>
</form>


{% include "themes/NeoLearn/includes/modalsForms/modal_create_category.html" with modal_id="modalCreateCategory" modal_title="Nova Categoria" %}



{% endblock %}

{% block extra_js %}
<script>
// ========== PREVIEW DE THUMBNAIL ==========
const thumbnailInput = document.getElementById('thumbnail');
const thumbnailArea = document.getElementById('thumbnailUploadArea');
const thumbnailPreview = document.getElementById('thumbnailPreview');

thumbnailArea.addEventListener('click', () => {
    thumbnailInput.click();
});

thumbnailArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    thumbnailArea.classList.add('drag-over');
});

thumbnailArea.addEventListener('dragleave', () => {
    thumbnailArea.classList.remove('drag-over');
});

thumbnailArea.addEventListener('drop', (e) => {
    e.preventDefault();
    thumbnailArea.classList.remove('drag-over');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        thumbnailInput.files = files;
        previewThumbnail(files[0]);
    }
});

thumbnailInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        previewThumbnail(e.target.files[0]);
    }
});

function previewThumbnail(file) {
    if (!file.type.startsWith('image/')) {
        alert('Por favor, selecione uma imagem válida.');
        return;
    }
    
    if (file.size > 2 * 1024 * 1024) {
        alert('A imagem deve ter no máximo 2MB.');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        thumbnailPreview.querySelector('img').src = e.target.result;
        thumbnailPreview.style.display = 'block';
        thumbnailArea.querySelector('.file-upload-content').style.display = 'none';
    };
    reader.readAsDataURL(file);
}

function removeThumbnail() {
    thumbnailInput.value = '';
    thumbnailPreview.style.display = 'none';
    thumbnailArea.querySelector('.file-upload-content').style.display = 'flex';
}

// ========== VALIDAÇÃO DO FORMULÁRIO ==========
document.getElementById('courseCreateForm').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    const description = document.getElementById('description').value.trim();
    const category = document.getElementById('category').value;
    
    if (!title || !description || !category) {
        e.preventDefault();
        alert('Por favor, preencha todos os campos obrigatórios.');
        return false;
    }
    
    // Mostra loading no botão
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
        <svg class="spinner" width="20" height="20" viewBox="0 0 20 20">
            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" fill="none" opacity="0.3"/>
            <path d="M10 2a8 8 0 0 1 8 8" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>
        Criando...
    `;
});

// ========== AUTO-RESIZE TEXTAREA ==========
document.querySelectorAll('textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
});

// ========== CONTADOR DE CARACTERES ==========
function setupCharCounter(inputId, max) {
const input = document.getElementById(inputId);
if (!input) return;


const group = input.closest('.form-group');

input.addEventListener('input', function() {
    const length = this.value.length;

    let counter = group.querySelector('.char-counter');
    if (!counter) {
        counter = document.createElement('span');
        counter.className = 'char-counter';
        group.appendChild(counter);
    }

    counter.textContent = `${length}/${max}`;
    counter.style.color = length > max * 0.9 ? 'var(--error-600)' : 'var(--text-tertiary)';
});


}

// Configura os contadores para os campos desejados
setupCharCounter('title', 50);
setupCharCounter('short_description', 100);



colorText.addEventListener('input', (e) => {
    if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
        colorPicker.value = e.target.value;
    }
});

// ========== SUBMIT DO FORMULÁRIO DE CATEGORIA ==========
categoryForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalHTML = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
        <svg class="spinner" width="16" height="16" viewBox="0 0 16 16">
            <circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="2" fill="none" opacity="0.3"/>
            <path d="M8 2a6 6 0 0 1 6 6" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>
        Criando...
    `;
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: { 
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Adiciona a nova categoria ao select
            const option = new Option(data.category.name, data.category.id, true, true);
            categorySelect.add(option);
            
            // Fecha modal
            closeModal();
            
            // Mostra notificação
            showNotification('Categoria criada com sucesso!', 'success');
        } else {
            alert(data.error || 'Erro ao criar categoria');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao criar categoria. Tente novamente.');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalHTML;
    });
});

// ========== NOTIFICAÇÃO ==========
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M16 6L8 14l-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>${message}</span>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 10);
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>

{% endblock %}